# 智慧畜牧健康管理平台 - 产品需求文档 (PRD)

**版本：** 2.1
**日期：** 2024-08-23

---

## 1. 产品愿景与核心价值

*   **愿景：** 从"被动治疗"转向"主动预防"，通过数据驱动，实现每一头牲畜的精细化健康管理，最终提升牧场整体的生产效率和盈利能力。
*   **核心价值：**
    *   **降本增效：** 尽早发现并预警疫病，降低死亡率和治疗成本；精准识别发情期，提高配种成功率；预测分娩，减少新生幼崽死亡率。
    *   **解放人力：** 变人工巡查为远程自动监测，极大降低人力成本和劳动强度。
    *   **资产安全：** 通过追踪器实现牲畜资产的防盗、防丢失管理。
    *   **科学决策：** 所有管理行为都有数据支撑，帮助牧场主做出更科学的饲喂、繁育和销售决策。

---

## 2. 整体架构设计

平台整体架构分为数据采集、传输、平台和应用分析四个层次，核心是构建直接面向用户、创造核心价值的应用与分析层。

```mermaid
graph TD
    subgraph 数据采集层 (Data Acquisition)
        A[瘤胃胶囊<br>Rumen Bolus<br>体温、pH值、活动量]
        B[智能项圈/耳标追踪器<br>Tracker<br>位置、步数、活动模式]
        C[其他传感器<br>如：饮水槽传感器]
    end

    subgraph 数据传输层 (Data Transmission)
        A & B & C --> D{LoRaWAN 网关<br>LoRaWAN Gateway}
    end

    subgraph 数据平台层 (Data Platform)
        D --> E[ThingsBoard 平台<br>负责设备接入、数据收集与初步处理]
    end

    subgraph 应用与分析层 (Application & Analytics)
        E --> F[<B>智慧畜牧健康管理平台 (核心)</B>]
        F --> G((牧场管理者))
        F --> H((技术运维人员))
        F --> I((兽医/专家))
    end

    style F fill:#f9f,stroke:#333,stroke-width:2px
```

## 3. 使用场景 (User Scenarios)

*   **场景一：日常运营监控 (牧场主李经理)**
    *   李经理每天早上打开 **【牧场驾驶舱】**，首先查看核心KPI，对牧场整体情况（牲畜总数、健康分布）一目了然。接着，他查看GIS地图，牛群的实时位置和活动范围清晰可见，不同颜色的图标让他能快速识别出健康状态异常的牛。他注意到右侧的告警列表有两条新告警，点击后地图立即定位到对应的牛只。

*   **场景二：个体健康深度分析 (兽医王医生)**
    *   王医生接到预警，一头牛（耳标号 #3307）体温持续偏高。他打开 **【牲畜档案管理】**，搜索 #3307。在详情页，他不仅看到了这头牛的基本信息，还查看了它近72小时的体温和活动量连续曲线图，并回顾了历史告警记录。基于数据，他判断可能是初期感染，于是通过系统记录一条新的生命周期事件：”注射抗生素A 20ml“。

*   **场景三：设备故障排查与维护 (运维工程师小张)**
    *   小张在 **【设备监控】** 仪表盘上发现有3个设备处于“低电量”状态，5个设备“长时间离线”。他导出问题设备列表，并安排人员去现场更换电池或检查设备。同时，他发现一批追踪器有固件缺陷，于是在 **【固件管理与升级】** 中创建了一个FOTA任务，为这批设备远程推送了最新的稳定版固件。

*   **场景四：季度运营复盘 (牧场主李经理)**
    *   季度末，李经理需要向投资人汇报。他打开 **【统计报表分析】** 模块，选择了本季度的时间范围，查看了健康趋势、告警分类统计等图表。他将这些图表导出，轻松地完成了一份数据详实的运营报告。

---

## 4. 核心功能模块详述 (Features)

产品核心功能围绕8个主要模块构建，与 `animal_husbandry_prototype.html` 中定义的导航结构保持一致。

### 4.1 牧场驾驶舱 (Ranch Dashboard)
*   **FR1 (宏观KPI):** 以卡片形式展示核心运营指标：牲畜总数、设备在线率、健康状态分布（健康/亚健康/告警）、今日新增告警。
*   **FR2 (GIS地图监控):** 在GIS地图上实时展示所有牲畜的位置，并根据健康状态以不同颜色标识。支持地图的缩放、平移和点聚合。
*   **FR3 (牲畜信息摘要):** 点击地图上的牲畜图标，能弹出浮动信息卡片，展示其耳标号、健康状态、最新体温等关键信息，并提供跳转至完整档案的链接。
*   **FR4 (双告警列表):** 驾驶舱右侧面板将展示两个独立的告警列表：
    *   **健康告警:** 实时滚动展示最新的N条健康相关告警（如高温、活动量低）。此列表数据来源于持久化的告警记录。
    *   **越界告警:** 实时展示**当前正处于**围栏外的牲畜列表。此列表为动态查询结果，仅用于即时状态展示。
*   **FR5 (电子围栏):** 支持在地图上叠加展示预设的电子围栏区域。
*   **FR6 (告警列表交互):** 每个告警列表都提供“更多”链接，点击后可弹出一个包含该分类下所有告警记录的完整列表模态框。

### 4.2 电子围栏管理 (Electronic Fence Management) - 新增模块
*   **FR1 (围栏列表):** 提供一个独立的管理页面，以列表形式展示所有已创建的电子围栏，包括其名称、描述和状态（启用/禁用）。
*   **FR2 (围栏CRUD):** 支持对电子围栏进行标准的增、删、改、查操作。
*   **FR3 (交互式地图绘制):** 在新增或编辑围栏时，弹出的模态框内嵌一个可交互的地图。用户可以通过在地图上单击绘制多边形的顶点，双击或单击起点闭合图形，从而定义围栏的地理边界。
*   **FR4 (坐标自动生成):** 用户在地图上完成绘制后，系统自动将多边形的顶点坐标（经纬度序列）保存到表单中。
*   **FR5 (状态管理):** 支持启用或禁用围栏。只有启用的围栏才会用于驾驶舱的渲染和越界判断。

### 4.3 牲畜档案管理 (Animal Ledger)
*   **FR1 (一畜一档):** 实现对牲畜档案的增删改查，档案信息包括耳标号、类型、性别、畜群、出生日期等。
*   **FR2 (多维数据聚合):** 在牲畜详情页中，以Tab页或区块形式，聚合展示该牲畜的 **基本信息、绑定设备列表、历史遥测数据、历史告警记录、生命周期事件**。其中“历史遥测数据”区应包含：
    *   **关键指标图表:** 直观展示**体温、胃动量、步数**等核心健康指标的历史趋势曲线图。
    *   **原始数据日志:** 提供一个可查看原始遥测JSON报文的区域，方便技术人员进行数据溯源和问题排查。
*   **FR3 (设备绑定/解绑):** 支持为单个牲畜绑定或解绑一个或多个物联网设备（瘤胃胶囊、追踪器）。
*   **FR4 (生命周期事件记录):** 支持为牲畜手动记录关键生命周期事件，如出生、免疫、治疗、配种、分娩、转群等。

### 4.4 设备台账管理 (Device Ledger)
*   **FR1 (资产入库):** 提供从ThingsBoard平台按DevEUI同步设备信息的功能，作为设备入库的唯一来源。
*   **FR2 (资产信息维护):** 支持查看和编辑设备的业务属性，如设备别名、采购日期、设备型号等。
*   **FR3 (生命周期管理):** 精确管理设备 **物理资产** 的全生命周期状态：`库存中` -> `在用` -> `闲置` -> `维保中` -> `已报废`。
*   **FR4 (绑定关系查询):** 可查看设备当前或历史绑定过的牲畜信息。

### 4.5 AI预警中心 (Alarm Center)
*   **FR1 (告警集中展示):** 以列表形式集中展示所有来源（实时规则、AI分析）的告警记录。
*   **FR2 (多维筛选查询):** 支持按告警级别、处理状态、告警类型、时间范围等维度对告警进行筛选和查询。
*   **FR3 (告警闭环处理):** 支持对“待处理”的告警进行 **“处理”** 或 **“忽略”** 操作。处理时可填写备注信息，形成完整的处理日志。
*   **FR4 (状态与权限):** 告警处理状态（`待处理`、`已解决`、`已忽略`）清晰明确，操作按钮根据状态和用户权限动态显示。

### 4.6 告警规则配置 (Alarm Rule Configuration)
*   **FR1 (规则管理):** 实现对告警规则的增删改查和启用/禁用。
*   **FR2 (触发条件定义):** 支持灵活定义规则的触发条件，包括：`监控项` (如体温), `操作符` (大于/小于/等于), `阈值`。
*   **FR3 (动态监控项):** `监控项` 的下拉列表能根据所选的`设备类型`（瘤胃胶囊/追踪器）进行动态加载，确保配置的有效性。
*   **FR4 (时间窗支持):** 支持配置一个“持续时间”，要求条件必须满足一定时长后才触发告警，以减少误报（如：体温`持续`高于39.5度`10分钟`）。

### 4.7 统计报表分析 (Statistics & Reports)
*   **FR1 (健康趋势分析):** 以折线图或堆叠面积图形式，展示全场或特定畜群在选定时间范围内的牲畜健康状态分布趋势。
*   **FR2 (告警统计分析):** 以饼图或柱状图形式，按告警类型、告警级别进行分类统计，帮助定位主要风险类型。
*   **FR3 (生理指标趋势):** 展示关键生理指标（如平均体温、平均活动量）的日/月度趋势图。
*   **FR4 (数据导出):** 支持将报表数据导出为Excel或CSV格式，以供离线分析。
*   **NFR1 (性能要求):** 报表查询须在5秒内返回。为达成此目标，系统应采用 **“批处理预聚合”** 模式，通过每日定时任务生成统计快照，前端查询时直接访问快照表。

### 4.8 固件管理与升级 (FOTA)
*   **FR1 (固件版本库):** 支持上传固件文件，并记录其版本号、适用的设备类型、文件大小、校验和(MD5/SHA256)以及版本更新说明。
*   **FR2 (版本管理):** 提供所有固件版本的列表，支持查看详情和删除。
*   **FR3 (升级任务创建):** 支持创建FOTA升级任务，并可灵活选择升级范围：`全部设备`、`按畜群`、`按设备ID列表`。
*   **FR4 (任务监控):** （V1.1）提供升级任务的执行状态概览，展示成功、失败、待处理的设备数量。

---

## 5. 非功能性需求 (Non-Functional Requirements)

*   **性能 (Performance):**
    *   驾驶舱地图数据接口在牲畜过万时，响应时间应小于1秒。
    *   列表查询页面在数据量过10万时，响应时间应小于2秒。
*   **安全性 (Security):**
    *   所有API需经过身份认证和权限校验。
    *   删除等高危操作需有二次确认。
*   **可靠性 (Reliability):**
    *   核心业务操作（如绑定/解绑、告警处理）必须保证数据库事务一致性。
    *   与第三方平台（ThingsBoard）的API交互必须有明确的超时和重试机制。
*   **易用性 (Usability):**
    *   遵循 `animal_husbandry_prototype.html` 定义的交互设计，工作流清晰流畅。
    *   错误提示信息需清晰、用户友好。

---

## 6. 实施路线图 (Roadmap)

*   **V1.0 (核心框架与数据链路):**
    *   **目标:** 打通从设备到平台的数据全链路，实现核心监控与管理闭环。
    *   **包含模块:** 牧场驾驶舱, 牲畜档案管理, 设备台账管理, 设备监控, AI预警中心, 告警规则配置, **电子围栏管理**。
*   **V1.1 (运营支撑与智能化增强):**
    *   **目标:** 增强运营支撑能力和AI应用深度。
    *   **包含模块:** 统计报表分析, 固件管理与升级(FOTA)。引入更复杂的AI算法模型，实现事件驱动的持久化越界告警。
*   **V2.0 (多租户与开放平台):**
    *   **目标:** 支持多牧场/多租户模式，对外提供API。
    *   **包含模块:** 完善的用户与权限管理体系，开放API网关。

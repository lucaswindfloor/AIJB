# 胶囊BC-100设备ThingsBoard规则链说明

## 概述

本文档介绍了胶囊BC-100设备在ThingsBoard平台上的规则链配置。该规则链专门用于处理胶囊设备通过LoRaWAN网络上报的传感器数据，包括温度、胃动力、加速度等关键指标。

## 规则链架构

### 主要功能模块

1. **数据接收与解码**
   - 接收LoRaWAN网络上报的Base64编码数据
   - 使用胶囊专用解码器解析传感器数据
   - 支持两种数据格式（0xF2和0xC1-0xC6）

2. **数据处理与存储**
   - 保存时序数据到ThingsBoard数据库
   - 保存设备属性和状态信息
   - 过滤无效数据包

3. **告警监控**
   - 温度异常告警（正常范围：36-42°C）
   - 传感器状态异常告警
   - 支持多种异常状态检测

4. **数据推送**
   - 通过Kafka推送遥测数据
   - 设备创建事件通知
   - 支持多租户数据隔离

## 解码器功能说明

### 支持的数据格式

#### 格式1：0xF2开头的数据包
- **温度**：16位有符号整数，除以100得到摄氏度
- **胃动力**：32位无符号整数
- **加速度**：X、Y、Z三轴8位有符号整数
- **电池电量**：8位无符号整数

#### 格式2：0xC1-0xC6开头的数据包
- **传感器状态**：包含重启、加速度初始化失败、CRC错误等状态
- **多点温度**：最多7个温度点（Temperature、Temperature_1到Temperature_6）
- **胃动力**：32位无符号整数

### 传感器状态代码
- `Reboot`：设备重启
- `ACC XYZ Same`：加速度三轴数值相同
- `ACC Init Fail`：加速度传感器初始化失败
- `Temperature unusual`：温度异常
- `CRC ERROR`：数据校验错误
- `NO ACK`：无应答

## 告警规则

### 温度异常告警
- **触发条件**：温度 < 36°C 或 > 42°C
- **告警类型**：Temperature Abnormal
- **严重级别**：WARNING
- **告警详情**：包含当前温度值、阈值范围、设备名称

### 传感器异常告警
- **触发条件**：传感器状态为以下之一
  - ACC Init Fail
  - CRC ERROR
  - Temperature unusual
- **告警类型**：Sensor Abnormal
- **严重级别**：CRITICAL
- **告警详情**：包含传感器状态、设备名称

## Kafka数据推送

### 遥测数据推送
- **Topic模式**：`capsule_telemetry_${tenant_id}`
- **数据内容**：
  ```json
  {
    "deviceName": "设备名称",
    "ts": 时间戳,
    "data": {
      "Temperature": 温度值,
      "Gastric_momentum": 胃动力值,
      "acc_x": X轴加速度,
      "acc_y": Y轴加速度,
      "acc_z": Z轴加速度,
      "Bat": 电池电量,
      "sensorStatus": "传感器状态"
    },
    "base64Data": "原始Base64数据"
  }
  ```

### 设备创建事件
- **Topic模式**：`create_capsule_${tenant_id}`
- **触发时机**：设备首次连接或创建时

## 与车位锁规则链的差异

| 特性 | 胶囊规则链 | 车位锁规则链 |
|------|-----------|-------------|
| 解码协议 | LoRaWAN专用协议 | 蓝牙+自定义协议 |
| 主要数据 | 温度、胃动力、加速度 | 锁状态、电压、车辆检测 |
| 告警类型 | 温度异常、传感器故障 | 地锁故障、控制失败 |
| Kafka Topic | capsule_telemetry_* | telemetry_* |
| 下发指令 | 基本配置（编码器简单） | 复杂的锁控制指令 |

## 部署配置

### 前置条件
1. ThingsBoard平台（版本3.x以上）
2. Kafka集群（用于数据推送）
3. LoRaWAN网关和网络服务器

### 配置步骤
1. 导入规则链JSON文件到ThingsBoard
2. 配置Kafka连接参数（默认：172.22.3.102:9092,172.22.3.102:9093）
3. 设置设备档案，关联到胶囊规则链
4. 配置LoRaWAN网关规则链ID（默认：4b7bc460-e907-11ef-a8ee-99a8c68f9649）

### 注意事项
- 确保Kafka集群可访问
- 根据实际部署环境调整Kafka服务器地址
- 建议开启调试模式进行初期测试
- 定期检查告警规则的阈值设置

## 扩展功能

### 可扩展的编码器
当前编码器功能较为简单，可根据需要扩展：
- 设备配置参数下发
- 采样频率调整
- 告警阈值远程设置

### 自定义告警规则
可在设备档案中配置更多告警规则：
- 胃动力异常检测
- 设备离线告警
- 电池低电量告警

## 监控与维护

### 关键指标监控
- 数据包接收率
- 解码成功率
- 告警触发频率
- Kafka推送成功率

### 故障排查
1. 检查设备LoRaWAN连接状态
2. 验证数据解码是否正确
3. 确认Kafka服务可用性
4. 查看ThingsBoard日志中的错误信息

---

**注意**：此规则链基于车位锁规则链架构设计，充分利用了ThingsBoard的规则引擎功能，为胶囊设备提供了完整的数据处理、监控和告警解决方案。 
# 时序数据库实施方案

## 📈 **当前问题与解决方案**

### **问题：** 历史曲线图需要时序数据，但时序数据库尚未部署

### **解决方案：** 分阶段实施，先用MySQL模拟，后续迁移到时序数据库

---

## 🎯 **分阶段实施策略**

### **阶段1：MySQL模拟方案（立即可用）**

#### **创建历史数据模拟表**
```sql
-- 创建遥测数据历史表（MySQL实现）
CREATE TABLE `ah_telemetry_history` (
  `id` varchar(36) NOT NULL COMMENT '主键ID',
  `device_id` varchar(36) NOT NULL COMMENT '设备ID',
  `telemetry_key` varchar(50) NOT NULL COMMENT '遥测字段名 (temperature, activity, ph, gps等)',
  `telemetry_value` decimal(10,4) NOT NULL COMMENT '遥测值',
  `unit` varchar(20) DEFAULT NULL COMMENT '单位',
  `timestamp` datetime(3) NOT NULL COMMENT '时间戳',
  `create_time` datetime(3) DEFAULT CURRENT_TIMESTAMP(3),
  PRIMARY KEY (`id`),
  KEY `idx_device_key_time` (`device_id`, `telemetry_key`, `timestamp`),
  KEY `idx_timestamp` (`timestamp`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='遥测数据历史记录表(MySQL模拟时序数据库)';

-- 为GPS数据创建专门的位置历史表
CREATE TABLE `ah_location_history` (
  `id` varchar(36) NOT NULL COMMENT '主键ID',
  `device_id` varchar(36) NOT NULL COMMENT '设备ID (追踪器)',
  `longitude` decimal(10,7) NOT NULL COMMENT '经度',
  `latitude` decimal(10,7) NOT NULL COMMENT '纬度',
  `altitude` decimal(8,2) DEFAULT NULL COMMENT '海拔(米)',
  `accuracy` decimal(6,2) DEFAULT NULL COMMENT 'GPS精度(米)',
  `timestamp` datetime(3) NOT NULL COMMENT '时间戳',
  `create_time` datetime(3) DEFAULT CURRENT_TIMESTAMP(3),
  PRIMARY KEY (`id`),
  KEY `idx_device_time` (`device_id`, `timestamp`),
  KEY `idx_timestamp` (`timestamp`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='GPS位置历史记录表';
```

#### **生成模拟历史数据**
```sql
-- 为现有设备生成近7天的模拟历史数据
DELIMITER $$

CREATE PROCEDURE GenerateHistoricalTelemetryData()
BEGIN
    DECLARE done INT DEFAULT FALSE;
    DECLARE device_id VARCHAR(36);
    DECLARE device_type VARCHAR(20);
    DECLARE cur CURSOR FOR 
        SELECT id, device_type FROM ah_device WHERE status = 'ACTIVE';
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

    OPEN cur;
    device_loop: LOOP
        FETCH cur INTO device_id, device_type;
        IF done THEN
            LEAVE device_loop;
        END IF;

        -- 为每个设备生成过去7天的数据，每小时一条记录
        SET @i = 0;
        WHILE @i < 168 DO  -- 7天 * 24小时 = 168条记录
            SET @timestamp = DATE_SUB(NOW(), INTERVAL @i HOUR);
            
            IF device_type = 'CAPSULE' THEN
                -- 瘤胃胶囊数据：体温(37-42℃)、活动量(0-12000)、pH值(5.5-7.5)
                INSERT INTO ah_telemetry_history (id, device_id, telemetry_key, telemetry_value, unit, timestamp)
                VALUES 
                    (UUID(), device_id, 'temperature', 37 + RAND() * 5, '℃', @timestamp),
                    (UUID(), device_id, 'activity', FLOOR(RAND() * 12000), '次/小时', @timestamp),
                    (UUID(), device_id, 'ph', 5.5 + RAND() * 2, 'pH', @timestamp);
            END IF;
            
            IF device_type = 'TRACKER' THEN
                -- 追踪器数据：步数(0-2000/小时)
                INSERT INTO ah_telemetry_history (id, device_id, telemetry_key, telemetry_value, unit, timestamp)
                VALUES 
                    (UUID(), device_id, 'steps', FLOOR(RAND() * 2000), '步/小时', @timestamp);
                    
                -- GPS位置数据（围绕一个中心点随机移动）
                SET @base_lon = 119.758;
                SET @base_lat = 49.217;
                SET @lon_offset = (RAND() - 0.5) * 0.01;  -- ±0.01度约等于±1公里
                SET @lat_offset = (RAND() - 0.5) * 0.01;
                
                INSERT INTO ah_location_history (id, device_id, longitude, latitude, accuracy, timestamp)
                VALUES 
                    (UUID(), device_id, @base_lon + @lon_offset, @base_lat + @lat_offset, 5 + RAND() * 10, @timestamp);
            END IF;
            
            -- 所有设备都有的数据：电量(逐渐衰减)、信号强度
            INSERT INTO ah_telemetry_history (id, device_id, telemetry_key, telemetry_value, unit, timestamp)
            VALUES 
                (UUID(), device_id, 'battery', 100 - (@i * 0.05), '%', @timestamp),
                (UUID(), device_id, 'rssi', -60 - RAND() * 40, 'dBm', @timestamp),
                (UUID(), device_id, 'snr', 5 + RAND() * 10, 'dB', @timestamp);
            
            SET @i = @i + 1;
        END WHILE;
    END LOOP;
    CLOSE cur;
END$$

DELIMITER ;

-- 执行存储过程生成数据
CALL GenerateHistoricalTelemetryData();

-- 清理存储过程
DROP PROCEDURE GenerateHistoricalTelemetryData;
```

#### **API接口实现（基于MySQL）**
```java
// TelemetryHistoryService.java
@Service
public class TelemetryHistoryServiceImpl implements ITelemetryHistoryService {
    
    @Autowired
    private TelemetryHistoryMapper telemetryHistoryMapper;
    
    @Override
    public List<TelemetryDataPoint> getAnimalTelemetryHistory(String animalId, String telemetryKey, 
            LocalDateTime startTime, LocalDateTime endTime, String interval) {
        
        // 1. 根据animalId查找绑定的设备
        List<String> deviceIds = getDeviceIdsByAnimalId(animalId);
        
        // 2. 查询这些设备的历史数据
        return telemetryHistoryMapper.selectTelemetryHistory(deviceIds, telemetryKey, startTime, endTime, interval);
    }
    
    @Override
    public List<LocationPoint> getAnimalLocationHistory(String animalId, 
            LocalDateTime startTime, LocalDateTime endTime) {
        
        // 查询追踪器设备的GPS历史数据
        List<String> trackerIds = getTrackerDeviceIdsByAnimalId(animalId);
        return locationHistoryMapper.selectLocationHistory(trackerIds, startTime, endTime);
    }
}
```

---

### **阶段2：时序数据库迁移方案（未来优化）**

#### **选择TDengine作为时序数据库**
```bash
# Docker部署TDengine
docker run -d --name tdengine \
  -p 6030:6030 -p 6041:6041 \
  -v /data/taos/log:/var/log/taos \
  -v /data/taos/data:/var/lib/taos \
  tdengine/tdengine:latest
```

#### **创建TDengine数据模型**
```sql
-- 连接TDengine
CREATE DATABASE livestock;
USE livestock;

-- 创建超级表：设备遥测数据
CREATE STABLE telemetry_data (
    ts TIMESTAMP,
    temperature FLOAT,
    activity INT,
    ph FLOAT,
    steps INT,
    battery INT,
    rssi INT,
    snr FLOAT
) TAGS (
    device_id NCHAR(36),
    device_type NCHAR(20),
    animal_id NCHAR(36)
);

-- 创建超级表：GPS位置数据
CREATE STABLE location_data (
    ts TIMESTAMP,
    longitude DOUBLE,
    latitude DOUBLE,
    altitude FLOAT,
    accuracy FLOAT
) TAGS (
    device_id NCHAR(36),
    animal_id NCHAR(36)
);
```

#### **数据迁移脚本**
```java
// 将MySQL历史数据迁移到TDengine
@Component
public class TelemetryDataMigration {
    
    @Autowired
    private TDengineTemplate tdengineTemplate;
    
    @Autowired
    private TelemetryHistoryMapper telemetryHistoryMapper;
    
    public void migrateHistoricalData() {
        // 1. 从MySQL读取历史数据
        List<TelemetryHistory> mysqlData = telemetryHistoryMapper.selectAll();
        
        // 2. 批量插入到TDengine
        for (TelemetryHistory record : mysqlData) {
            String sql = "INSERT INTO device_" + record.getDeviceId() + 
                        " USING telemetry_data TAGS (?, ?, ?) VALUES (?, ?, ?, ?, ?, ?, ?, ?)";
            tdengineTemplate.execute(sql, /* 参数 */);
        }
    }
}
```

---

## 🚀 **立即实施建议**

### **第一步：执行MySQL模拟方案**
```bash
# 在你的MySQL中执行
mysql -u root -p jeecg-boot < jeecg-boot/db/create_telemetry_tables.sql
mysql -u root -p jeecg-boot < jeecg-boot/db/generate_historical_data.sql
```

### **第二步：修改现有API接口**
```java
// AnimalController.java 中新增接口
@GetMapping(value = "/getTelemetryHistory")
public Result<TelemetryHistoryVo> getTelemetryHistory(
        @RequestParam String animalId,
        @RequestParam String telemetryKey,
        @RequestParam @DateTimeFormat(pattern = "yyyy-MM-dd HH:mm:ss") LocalDateTime startTime,
        @RequestParam @DateTimeFormat(pattern = "yyyy-MM-dd HH:mm:ss") LocalDateTime endTime,
        @RequestParam(defaultValue = "1h") String interval) {
    
    List<TelemetryDataPoint> dataPoints = telemetryHistoryService
        .getAnimalTelemetryHistory(animalId, telemetryKey, startTime, endTime, interval);
    
    TelemetryHistoryVo result = new TelemetryHistoryVo();
    result.setTelemetryKey(telemetryKey);
    result.setDataPoints(dataPoints);
    return Result.OK(result);
}
```

### **第三步：前端图表组件开发**
```vue
<!-- TelemetryChart.vue -->
<template>
  <div class="telemetry-chart">
    <div ref="chartContainer" style="height: 300px;"></div>
  </div>
</template>

<script setup>
import * as echarts from 'echarts'
import { getTelemetryHistory } from '@/api/animal'

const props = defineProps({
  animalId: String,
  telemetryKey: String,
  title: String,
  unit: String,
  timeRange: { type: Number, default: 7 } // 天数
})

const chartContainer = ref()
let chart = null

onMounted(() => {
  initChart()
  loadData()
})

const loadData = async () => {
  const endTime = new Date()
  const startTime = new Date(endTime.getTime() - props.timeRange * 24 * 60 * 60 * 1000)
  
  const { result } = await getTelemetryHistory({
    animalId: props.animalId,
    telemetryKey: props.telemetryKey,
    startTime: formatDateTime(startTime),
    endTime: formatDateTime(endTime),
    interval: '1h'
  })
  
  const option = {
    title: { text: props.title },
    xAxis: { 
      type: 'time',
      data: result.dataPoints.map(p => p.timestamp)
    },
    yAxis: { 
      type: 'value',
      name: props.unit
    },
    series: [{
      type: 'line',
      data: result.dataPoints.map(p => [p.timestamp, p.value]),
      smooth: true
    }]
  }
  
  chart.setOption(option)
}
</script>
```

---

## ⚡ **总结**

1. **短期方案：** 用MySQL模拟时序数据库，立即可用
2. **长期方案：** 迁移到TDengine等专业时序数据库
3. **优势：** 
   - ✅ 可以立即开始开发图表功能
   - ✅ 后续迁移对前端透明
   - ✅ 避免了架构复杂度

**建议先执行MySQL方案，把功能跑起来，后续再优化到时序数据库！** 
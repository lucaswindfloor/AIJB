# æ—¶åºæ•°æ®åº“å®æ–½æ–¹æ¡ˆ

## ğŸ“ˆ **å½“å‰é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ**

### **é—®é¢˜ï¼š** å†å²æ›²çº¿å›¾éœ€è¦æ—¶åºæ•°æ®ï¼Œä½†æ—¶åºæ•°æ®åº“å°šæœªéƒ¨ç½²

### **è§£å†³æ–¹æ¡ˆï¼š** åˆ†é˜¶æ®µå®æ–½ï¼Œå…ˆç”¨MySQLæ¨¡æ‹Ÿï¼Œåç»­è¿ç§»åˆ°æ—¶åºæ•°æ®åº“

---

## ğŸ¯ **åˆ†é˜¶æ®µå®æ–½ç­–ç•¥**

### **é˜¶æ®µ1ï¼šMySQLæ¨¡æ‹Ÿæ–¹æ¡ˆï¼ˆç«‹å³å¯ç”¨ï¼‰**

#### **åˆ›å»ºå†å²æ•°æ®æ¨¡æ‹Ÿè¡¨**
```sql
-- åˆ›å»ºé¥æµ‹æ•°æ®å†å²è¡¨ï¼ˆMySQLå®ç°ï¼‰
CREATE TABLE `ah_telemetry_history` (
  `id` varchar(36) NOT NULL COMMENT 'ä¸»é”®ID',
  `device_id` varchar(36) NOT NULL COMMENT 'è®¾å¤‡ID',
  `telemetry_key` varchar(50) NOT NULL COMMENT 'é¥æµ‹å­—æ®µå (temperature, activity, ph, gpsç­‰)',
  `telemetry_value` decimal(10,4) NOT NULL COMMENT 'é¥æµ‹å€¼',
  `unit` varchar(20) DEFAULT NULL COMMENT 'å•ä½',
  `timestamp` datetime(3) NOT NULL COMMENT 'æ—¶é—´æˆ³',
  `create_time` datetime(3) DEFAULT CURRENT_TIMESTAMP(3),
  PRIMARY KEY (`id`),
  KEY `idx_device_key_time` (`device_id`, `telemetry_key`, `timestamp`),
  KEY `idx_timestamp` (`timestamp`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='é¥æµ‹æ•°æ®å†å²è®°å½•è¡¨(MySQLæ¨¡æ‹Ÿæ—¶åºæ•°æ®åº“)';

-- ä¸ºGPSæ•°æ®åˆ›å»ºä¸“é—¨çš„ä½ç½®å†å²è¡¨
CREATE TABLE `ah_location_history` (
  `id` varchar(36) NOT NULL COMMENT 'ä¸»é”®ID',
  `device_id` varchar(36) NOT NULL COMMENT 'è®¾å¤‡ID (è¿½è¸ªå™¨)',
  `longitude` decimal(10,7) NOT NULL COMMENT 'ç»åº¦',
  `latitude` decimal(10,7) NOT NULL COMMENT 'çº¬åº¦',
  `altitude` decimal(8,2) DEFAULT NULL COMMENT 'æµ·æ‹”(ç±³)',
  `accuracy` decimal(6,2) DEFAULT NULL COMMENT 'GPSç²¾åº¦(ç±³)',
  `timestamp` datetime(3) NOT NULL COMMENT 'æ—¶é—´æˆ³',
  `create_time` datetime(3) DEFAULT CURRENT_TIMESTAMP(3),
  PRIMARY KEY (`id`),
  KEY `idx_device_time` (`device_id`, `timestamp`),
  KEY `idx_timestamp` (`timestamp`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='GPSä½ç½®å†å²è®°å½•è¡¨';
```

#### **ç”Ÿæˆæ¨¡æ‹Ÿå†å²æ•°æ®**
```sql
-- ä¸ºç°æœ‰è®¾å¤‡ç”Ÿæˆè¿‘7å¤©çš„æ¨¡æ‹Ÿå†å²æ•°æ®
DELIMITER $$

CREATE PROCEDURE GenerateHistoricalTelemetryData()
BEGIN
    DECLARE done INT DEFAULT FALSE;
    DECLARE device_id VARCHAR(36);
    DECLARE device_type VARCHAR(20);
    DECLARE cur CURSOR FOR 
        SELECT id, device_type FROM ah_device WHERE status = 'ACTIVE';
    DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

    OPEN cur;
    device_loop: LOOP
        FETCH cur INTO device_id, device_type;
        IF done THEN
            LEAVE device_loop;
        END IF;

        -- ä¸ºæ¯ä¸ªè®¾å¤‡ç”Ÿæˆè¿‡å»7å¤©çš„æ•°æ®ï¼Œæ¯å°æ—¶ä¸€æ¡è®°å½•
        SET @i = 0;
        WHILE @i < 168 DO  -- 7å¤© * 24å°æ—¶ = 168æ¡è®°å½•
            SET @timestamp = DATE_SUB(NOW(), INTERVAL @i HOUR);
            
            IF device_type = 'CAPSULE' THEN
                -- ç˜¤èƒƒèƒ¶å›Šæ•°æ®ï¼šä½“æ¸©(37-42â„ƒ)ã€æ´»åŠ¨é‡(0-12000)ã€pHå€¼(5.5-7.5)
                INSERT INTO ah_telemetry_history (id, device_id, telemetry_key, telemetry_value, unit, timestamp)
                VALUES 
                    (UUID(), device_id, 'temperature', 37 + RAND() * 5, 'â„ƒ', @timestamp),
                    (UUID(), device_id, 'activity', FLOOR(RAND() * 12000), 'æ¬¡/å°æ—¶', @timestamp),
                    (UUID(), device_id, 'ph', 5.5 + RAND() * 2, 'pH', @timestamp);
            END IF;
            
            IF device_type = 'TRACKER' THEN
                -- è¿½è¸ªå™¨æ•°æ®ï¼šæ­¥æ•°(0-2000/å°æ—¶)
                INSERT INTO ah_telemetry_history (id, device_id, telemetry_key, telemetry_value, unit, timestamp)
                VALUES 
                    (UUID(), device_id, 'steps', FLOOR(RAND() * 2000), 'æ­¥/å°æ—¶', @timestamp);
                    
                -- GPSä½ç½®æ•°æ®ï¼ˆå›´ç»•ä¸€ä¸ªä¸­å¿ƒç‚¹éšæœºç§»åŠ¨ï¼‰
                SET @base_lon = 119.758;
                SET @base_lat = 49.217;
                SET @lon_offset = (RAND() - 0.5) * 0.01;  -- Â±0.01åº¦çº¦ç­‰äºÂ±1å…¬é‡Œ
                SET @lat_offset = (RAND() - 0.5) * 0.01;
                
                INSERT INTO ah_location_history (id, device_id, longitude, latitude, accuracy, timestamp)
                VALUES 
                    (UUID(), device_id, @base_lon + @lon_offset, @base_lat + @lat_offset, 5 + RAND() * 10, @timestamp);
            END IF;
            
            -- æ‰€æœ‰è®¾å¤‡éƒ½æœ‰çš„æ•°æ®ï¼šç”µé‡(é€æ¸è¡°å‡)ã€ä¿¡å·å¼ºåº¦
            INSERT INTO ah_telemetry_history (id, device_id, telemetry_key, telemetry_value, unit, timestamp)
            VALUES 
                (UUID(), device_id, 'battery', 100 - (@i * 0.05), '%', @timestamp),
                (UUID(), device_id, 'rssi', -60 - RAND() * 40, 'dBm', @timestamp),
                (UUID(), device_id, 'snr', 5 + RAND() * 10, 'dB', @timestamp);
            
            SET @i = @i + 1;
        END WHILE;
    END LOOP;
    CLOSE cur;
END$$

DELIMITER ;

-- æ‰§è¡Œå­˜å‚¨è¿‡ç¨‹ç”Ÿæˆæ•°æ®
CALL GenerateHistoricalTelemetryData();

-- æ¸…ç†å­˜å‚¨è¿‡ç¨‹
DROP PROCEDURE GenerateHistoricalTelemetryData;
```

#### **APIæ¥å£å®ç°ï¼ˆåŸºäºMySQLï¼‰**
```java
// TelemetryHistoryService.java
@Service
public class TelemetryHistoryServiceImpl implements ITelemetryHistoryService {
    
    @Autowired
    private TelemetryHistoryMapper telemetryHistoryMapper;
    
    @Override
    public List<TelemetryDataPoint> getAnimalTelemetryHistory(String animalId, String telemetryKey, 
            LocalDateTime startTime, LocalDateTime endTime, String interval) {
        
        // 1. æ ¹æ®animalIdæŸ¥æ‰¾ç»‘å®šçš„è®¾å¤‡
        List<String> deviceIds = getDeviceIdsByAnimalId(animalId);
        
        // 2. æŸ¥è¯¢è¿™äº›è®¾å¤‡çš„å†å²æ•°æ®
        return telemetryHistoryMapper.selectTelemetryHistory(deviceIds, telemetryKey, startTime, endTime, interval);
    }
    
    @Override
    public List<LocationPoint> getAnimalLocationHistory(String animalId, 
            LocalDateTime startTime, LocalDateTime endTime) {
        
        // æŸ¥è¯¢è¿½è¸ªå™¨è®¾å¤‡çš„GPSå†å²æ•°æ®
        List<String> trackerIds = getTrackerDeviceIdsByAnimalId(animalId);
        return locationHistoryMapper.selectLocationHistory(trackerIds, startTime, endTime);
    }
}
```

---

### **é˜¶æ®µ2ï¼šæ—¶åºæ•°æ®åº“è¿ç§»æ–¹æ¡ˆï¼ˆæœªæ¥ä¼˜åŒ–ï¼‰**

#### **é€‰æ‹©TDengineä½œä¸ºæ—¶åºæ•°æ®åº“**
```bash
# Dockeréƒ¨ç½²TDengine
docker run -d --name tdengine \
  -p 6030:6030 -p 6041:6041 \
  -v /data/taos/log:/var/log/taos \
  -v /data/taos/data:/var/lib/taos \
  tdengine/tdengine:latest
```

#### **åˆ›å»ºTDengineæ•°æ®æ¨¡å‹**
```sql
-- è¿æ¥TDengine
CREATE DATABASE livestock;
USE livestock;

-- åˆ›å»ºè¶…çº§è¡¨ï¼šè®¾å¤‡é¥æµ‹æ•°æ®
CREATE STABLE telemetry_data (
    ts TIMESTAMP,
    temperature FLOAT,
    activity INT,
    ph FLOAT,
    steps INT,
    battery INT,
    rssi INT,
    snr FLOAT
) TAGS (
    device_id NCHAR(36),
    device_type NCHAR(20),
    animal_id NCHAR(36)
);

-- åˆ›å»ºè¶…çº§è¡¨ï¼šGPSä½ç½®æ•°æ®
CREATE STABLE location_data (
    ts TIMESTAMP,
    longitude DOUBLE,
    latitude DOUBLE,
    altitude FLOAT,
    accuracy FLOAT
) TAGS (
    device_id NCHAR(36),
    animal_id NCHAR(36)
);
```

#### **æ•°æ®è¿ç§»è„šæœ¬**
```java
// å°†MySQLå†å²æ•°æ®è¿ç§»åˆ°TDengine
@Component
public class TelemetryDataMigration {
    
    @Autowired
    private TDengineTemplate tdengineTemplate;
    
    @Autowired
    private TelemetryHistoryMapper telemetryHistoryMapper;
    
    public void migrateHistoricalData() {
        // 1. ä»MySQLè¯»å–å†å²æ•°æ®
        List<TelemetryHistory> mysqlData = telemetryHistoryMapper.selectAll();
        
        // 2. æ‰¹é‡æ’å…¥åˆ°TDengine
        for (TelemetryHistory record : mysqlData) {
            String sql = "INSERT INTO device_" + record.getDeviceId() + 
                        " USING telemetry_data TAGS (?, ?, ?) VALUES (?, ?, ?, ?, ?, ?, ?, ?)";
            tdengineTemplate.execute(sql, /* å‚æ•° */);
        }
    }
}
```

---

## ğŸš€ **ç«‹å³å®æ–½å»ºè®®**

### **ç¬¬ä¸€æ­¥ï¼šæ‰§è¡ŒMySQLæ¨¡æ‹Ÿæ–¹æ¡ˆ**
```bash
# åœ¨ä½ çš„MySQLä¸­æ‰§è¡Œ
mysql -u root -p jeecg-boot < jeecg-boot/db/create_telemetry_tables.sql
mysql -u root -p jeecg-boot < jeecg-boot/db/generate_historical_data.sql
```

### **ç¬¬äºŒæ­¥ï¼šä¿®æ”¹ç°æœ‰APIæ¥å£**
```java
// AnimalController.java ä¸­æ–°å¢æ¥å£
@GetMapping(value = "/getTelemetryHistory")
public Result<TelemetryHistoryVo> getTelemetryHistory(
        @RequestParam String animalId,
        @RequestParam String telemetryKey,
        @RequestParam @DateTimeFormat(pattern = "yyyy-MM-dd HH:mm:ss") LocalDateTime startTime,
        @RequestParam @DateTimeFormat(pattern = "yyyy-MM-dd HH:mm:ss") LocalDateTime endTime,
        @RequestParam(defaultValue = "1h") String interval) {
    
    List<TelemetryDataPoint> dataPoints = telemetryHistoryService
        .getAnimalTelemetryHistory(animalId, telemetryKey, startTime, endTime, interval);
    
    TelemetryHistoryVo result = new TelemetryHistoryVo();
    result.setTelemetryKey(telemetryKey);
    result.setDataPoints(dataPoints);
    return Result.OK(result);
}
```

### **ç¬¬ä¸‰æ­¥ï¼šå‰ç«¯å›¾è¡¨ç»„ä»¶å¼€å‘**
```vue
<!-- TelemetryChart.vue -->
<template>
  <div class="telemetry-chart">
    <div ref="chartContainer" style="height: 300px;"></div>
  </div>
</template>

<script setup>
import * as echarts from 'echarts'
import { getTelemetryHistory } from '@/api/animal'

const props = defineProps({
  animalId: String,
  telemetryKey: String,
  title: String,
  unit: String,
  timeRange: { type: Number, default: 7 } // å¤©æ•°
})

const chartContainer = ref()
let chart = null

onMounted(() => {
  initChart()
  loadData()
})

const loadData = async () => {
  const endTime = new Date()
  const startTime = new Date(endTime.getTime() - props.timeRange * 24 * 60 * 60 * 1000)
  
  const { result } = await getTelemetryHistory({
    animalId: props.animalId,
    telemetryKey: props.telemetryKey,
    startTime: formatDateTime(startTime),
    endTime: formatDateTime(endTime),
    interval: '1h'
  })
  
  const option = {
    title: { text: props.title },
    xAxis: { 
      type: 'time',
      data: result.dataPoints.map(p => p.timestamp)
    },
    yAxis: { 
      type: 'value',
      name: props.unit
    },
    series: [{
      type: 'line',
      data: result.dataPoints.map(p => [p.timestamp, p.value]),
      smooth: true
    }]
  }
  
  chart.setOption(option)
}
</script>
```

---

## âš¡ **æ€»ç»“**

1. **çŸ­æœŸæ–¹æ¡ˆï¼š** ç”¨MySQLæ¨¡æ‹Ÿæ—¶åºæ•°æ®åº“ï¼Œç«‹å³å¯ç”¨
2. **é•¿æœŸæ–¹æ¡ˆï¼š** è¿ç§»åˆ°TDengineç­‰ä¸“ä¸šæ—¶åºæ•°æ®åº“
3. **ä¼˜åŠ¿ï¼š** 
   - âœ… å¯ä»¥ç«‹å³å¼€å§‹å¼€å‘å›¾è¡¨åŠŸèƒ½
   - âœ… åç»­è¿ç§»å¯¹å‰ç«¯é€æ˜
   - âœ… é¿å…äº†æ¶æ„å¤æ‚åº¦

**å»ºè®®å…ˆæ‰§è¡ŒMySQLæ–¹æ¡ˆï¼ŒæŠŠåŠŸèƒ½è·‘èµ·æ¥ï¼Œåç»­å†ä¼˜åŒ–åˆ°æ—¶åºæ•°æ®åº“ï¼** 